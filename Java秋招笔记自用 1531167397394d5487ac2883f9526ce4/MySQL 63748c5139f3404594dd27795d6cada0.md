# MySQL

# åŸºç¡€

## MySQLé€»è¾‘æ¶æ„

### æ‰§è¡Œä¸€æ¡selectè¯­å¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

![mysqlæŸ¥è¯¢æµç¨‹.webp](MySQL%2063748c5139f3404594dd27795d6cada0/mysql%25E6%259F%25A5%25E8%25AF%25A2%25E6%25B5%2581%25E7%25A8%258B.webp)

- è¿æ¥å™¨ï¼šå»ºç«‹è¿æ¥ï¼Œç®¡ç†è¿æ¥ã€æ ¡éªŒç”¨æˆ·èº«ä»½ï¼›
- æŸ¥è¯¢ç¼“å­˜ï¼šæŸ¥è¯¢è¯­å¥å¦‚æœå‘½ä¸­æŸ¥è¯¢ç¼“å­˜åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚MySQL 8.0 å·²åˆ é™¤è¯¥æ¨¡å—ï¼›
- è§£æ SQLï¼Œé€šè¿‡è§£æå™¨å¯¹ SQL æŸ¥è¯¢è¯­å¥è¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æï¼Œç„¶åæ„å»ºè¯­æ³•æ ‘ï¼Œæ–¹ä¾¿åç»­æ¨¡å—è¯»å–è¡¨åã€å­—æ®µã€è¯­å¥ç±»å‹ï¼›
- æ‰§è¡Œ SQLï¼šæ‰§è¡Œ SQL å…±æœ‰ä¸‰ä¸ªé˜¶æ®µï¼š
    - é¢„å¤„ç†é˜¶æ®µï¼šæ£€æŸ¥è¡¨æˆ–å­—æ®µæ˜¯å¦å­˜åœ¨ï¼›å°†Â `select *`Â ä¸­çš„Â `*`Â ç¬¦å·æ‰©å±•ä¸ºè¡¨ä¸Šçš„æ‰€æœ‰åˆ—ã€‚
    - ä¼˜åŒ–é˜¶æ®µï¼šåŸºäºæŸ¥è¯¢æˆæœ¬çš„è€ƒè™‘ï¼Œ é€‰æ‹©æŸ¥è¯¢æˆæœ¬æœ€å°çš„æ‰§è¡Œè®¡åˆ’ï¼›
    - æ‰§è¡Œé˜¶æ®µï¼šæ ¹æ®æ‰§è¡Œè®¡åˆ’æ‰§è¡Œ SQL æŸ¥è¯¢è¯­å¥ï¼Œä»å­˜å‚¨å¼•æ“è¯»å–è®°å½•ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼›

## SQLè¯­å¥

### è¿æ¥

å°†å¤šä¸ªè¡¨æŒ‰ç…§åˆ—è¿›è¡Œå…³è”ã€‚

- å†…è¿æ¥ï¼šè¿”å›ä¸¤ä¸ªè¡¨ä¸­è¿æ¥å­—æ®µåŒ¹é…çš„è¡Œï¼Œå¦‚æœä¸€ä¸ªè¡¨ä¸­çš„è¡Œåœ¨å¦ä¸€ä¸ªè¡¨ä¸­æ²¡æœ‰åŒ¹é…çš„è¡Œï¼Œåˆ™ä¸ä¼šå‡ºç°åœ¨æŸ¥è¯¢ç»“æœä¸­ã€‚
- å¤–è¿æ¥ï¼š
    - å·¦å¤–è¿æ¥ï¼šé©±åŠ¨è¡¨æ•°æ®å…¨éƒ¨æ˜¾ç¤ºï¼Œè¢«é©±åŠ¨è¡¨ä¸åŒ¹é…çš„ä¸ä¼šæ˜¾ç¤ºã€‚
    - å³å¤–è¿æ¥ï¼šè¢«é©±åŠ¨è¡¨æ•°æ®å…¨éƒ¨æ˜¾ç¤ºï¼Œé©±åŠ¨è¡¨ä¸åŒ¹é…çš„ä¸ä¼šæ˜¾ç¤ºã€‚
- äº¤å‰è¿æ¥ï¼šç¬›å¡å°”ç§¯ï¼Œé©±åŠ¨è¡¨æ¯ä¸€è¡Œä¸è¢«é©±åŠ¨è¡¨æ¯ä¸€è¡Œçš„ç»„åˆã€‚

### DMLã€DDLå’ŒDCL

- DMLæ˜¯æ•°æ®æ“çºµè¯­è¨€ï¼Œå¦‚insertã€updateã€deleteã€selectç­‰ã€‚
- DDLæ˜¯æ•°æ®åº“å®šä¹‰è¯­è¨€ï¼Œå¦‚createã€dropã€truncateã€alterç­‰ã€‚
- DCLæ˜¯æ•°æ®åº“æ§åˆ¶è¯­è¨€ï¼Œå¦‚grantæˆæƒç­‰ã€‚

### **Dropã€Deleteä¸Truncateçš„åŒºåˆ«**

- Dropæ˜¯DDLï¼Œä»æ•°æ®åº“ä¸­åˆ é™¤è¡¨ï¼ŒåŒ…æ‹¬æ•°æ®è¡Œå’Œæ‰€æœ‰ç›¸å…³çš„å¯¹è±¡å¦‚ç´¢å¼•ï¼Œä¸å¯å›æ»šã€‚
- Deleteæ˜¯DMLï¼Œåˆ é™¤è¡¨ä¸­ç¬¦åˆæ¡ä»¶çš„è¡Œï¼Œè¡¨ç»“æ„è¿˜åœ¨ï¼Œå¯ä»¥å›æ»šã€‚
- Truncateæ˜¯DDLï¼Œåˆ é™¤è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œè¡¨ç»“æ„è¿˜åœ¨ï¼Œä¸å¯å›æ»šã€‚

### count(*)ã€count(1)ä¸count(å­—æ®µ)

- count(*)å’Œcount(1)æœ¬è´¨ç›¸åŒï¼ŒInnoDBæ¯è¿”å›ä¸€æ¡è®°å½•ï¼Œcountå€¼+1ã€‚æ•ˆç‡æ¯”ä¸»é”®å­—æ®µå¥½ï¼Œå› ä¸ºä¸»é”®å­—æ®µè¦è¯»å–å€¼ã€‚
- count(1)ã€ count(*)ã€ count(ä¸»é”®å­—æ®µ)åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æœè¡¨é‡Œå­˜åœ¨äºŒçº§ç´¢å¼•ï¼Œä¼˜åŒ–å™¨å°±ä¼šé€‰æ‹©äºŒçº§ç´¢å¼•è¿›è¡Œæ‰«æï¼Œå› ä¸ºäºŒçº§ç´¢å¼•å ç”¨æ›´å°çš„å­˜å‚¨ç©ºé—´ã€‚
- count(å­—æ®µ)æ¯”count(ä¸»é”®å­—æ®µ)æ•ˆç‡å·®ï¼Œå› ä¸ºä¼šå…¨è¡¨æ‰«æï¼Œæ‰€ä»¥å»ºè®®ç»™è¿™ä¸ªå­—æ®µå»ºç«‹äºŒçº§ç´¢å¼•ã€‚

### DDL

```sql
# æ•°æ®åº“
CREATE DATABASE [name] (IF NOT EXISTS); # åˆ›å»ºæ•°æ®åº“
DROP DATABASE (IF EXISTS) [name];       # åˆ é™¤æ•°æ®åº“

# æ•°æ®è¡¨
# æ–°å»ºè¡¨
CREATE TABLE [name] (
		[å­—æ®µå] [æ•°æ®ç±»å‹] NOT NULL UNIQUE,
		[å­—æ®µå] BOOLEAN DEFAULT TRUE,
		[å­—æ®µå] [æ•°æ®ç±»å‹] PRIMARY KEY AUTO_INCREMENT,
		......
		[å­—æ®µå] [æ•°æ®ç±»å‹],
		PRIMARY KEY([å­—æ®µå])
);
# åˆ é™¤è¡¨
DROP TABLE (IF EXISTS) [è¡¨å];
TRUNCATE TABLE [è¡¨å];
# ä¿®æ”¹è¡¨ç»“æ„
ALTER TABLE [è¡¨å] RENAME TO [æ–°è¡¨å];        # é‡å‘½å
ALTER TABLE [è¡¨å] ADD [åˆ—å] [æ•°æ®ç±»å‹];      # æ–°å¢åˆ—
ALTER TABLE [è¡¨å] DROP [åˆ—å];               # åˆ é™¤åˆ—
ALTER TABLE [è¡¨å] MODIFY [åˆ—å] [æ–°æ•°æ®ç±»å‹]; # ä¿®æ”¹æ•°æ®ç±»å‹
ALTER TABLE [è¡¨å] CHANGE [åˆ—å] [æ–°åˆ—å] [æ–°æ•°æ®ç±»å‹]; # ä¿®æ”¹åˆ—åå’Œæ•°æ®ç±»å‹
```

### DML

```sql
# å¢
INSERT INTO [è¡¨å] ([åˆ—å], [åˆ—å], ...) 
VALUES ([å€¼], [å€¼], ...),
			 ...
			 ([å€¼], [å€¼], ...);
			 
# åˆ 
DELETE FROM [è¡¨å] [WHERE æ¡ä»¶];
                                                                                                                                                                           
# æ”¹
UPDATE [è¡¨å]
SET [åˆ—å] = [å€¼], [åˆ—å] = [å€¼], ...
[WHERE æ¡ä»¶];

# æŸ¥
SELECT [å­—æ®µåˆ—è¡¨]          # 4 
FROM [è¡¨å]                # 1
WHERE [æ¡ä»¶]               # 2
GROUP BY [å­—æ®µåˆ—è¡¨]        # 3
HAVING [åˆ†ç»„åæ¡ä»¶]        
ORDER BY [å­—æ®µ] [ASC/DESC], [å­—æ®µ] [ASC/DESC], ...   # 5
LIMIT [èµ·å§‹ç´¢å¼•ä»0å¼€å§‹], [æŸ¥è¯¢æ¡æ•°]                   # 6
```

### å…¶ä»–SQL

```sql
# åˆ¤æ–­å­—æ®µæ˜¯å¦ä¸ºnullç”¨is null/is not null
where is null

# åˆ é™¤é‡å¤è¡Œç”¨distinctå…³é”®å­—
select distinct name from ...

# å­—ç¬¦ä¸²å‡½æ•°
select length(str) from ...
substring(åˆ—å, start, length)
upper(expr) å¤§å†™
lower(expr) å°å†™
concat(string1, string2, ...)

# æ•°å€¼å‡½æ•°
# ä¿ç•™å°æ•°ä½æ•°
select round(avg(a-b), 3) from ...
# å–ä½™æ•°mod(a,b)æ¯”a%bæ•ˆç‡é«˜
mod(a, b)
# å–æ•´
floor(a)
cell(a)

# count()ç”¨æ³•é«˜çº§
# count()ç­›é€‰å­—æ®µæ¡ä»¶æ—¶è¦åŠ ä¸Šor null
count(action='confirmed' or null)
# ç»Ÿè®¡æŸåˆ—ä¸­ä¸é‡å¤çš„è®°å½•ä¸ªæ•°
count(distinct å­—æ®µå)

# ifnullç±»ä¼¼äºgetOrDefault()
ifnull(a, 0)

# caseè¯­å¥
case
when ... then ...
when ... then ...
else ...
end

# group_concat()
GROUP_CONCAT(DISTINCT product ORDER BY product SEPARATOR ',')
```

### æ—¥æœŸæ“ä½œ

```sql
# æ—¥æœŸæ ¼å¼åŒ–
SELECT DATE_FORMAT('2022-01-08 22:23:01', '%Y%m%d%H%i%s');# 20220108222301
è¯´æ˜ï¼š
%W æ˜ŸæœŸåå­—(Sundayâ€¦â€¦Saturday) 
%D æœ‰è‹±è¯­å‰ç¼€çš„æœˆä»½çš„æ—¥æœŸ(1st, 2nd, 3rd, ç­‰ç­‰ã€‚)
%Y å¹´, æ•°å­—, 4 ä½ â˜…â˜…â˜…
%y å¹´, æ•°å­—, 2 ä½
%a ç¼©å†™çš„æ˜ŸæœŸåå­—(Sunâ€¦â€¦Sat)
%d æœˆä»½ä¸­çš„å¤©æ•°, æ•°å­—(00â€¦â€¦31) â˜…â˜…â˜…
%e æœˆä»½ä¸­çš„å¤©æ•°, æ•°å­—(0â€¦â€¦31)
%m æœˆ, æ•°å­—(01â€¦â€¦12) â˜…â˜…â˜… month
%c æœˆ, æ•°å­—(1â€¦â€¦12)
%b ç¼©å†™çš„æœˆä»½åå­—(Janâ€¦â€¦Dec)
%j ä¸€å¹´ä¸­çš„å¤©æ•°(001â€¦â€¦366)
%H å°æ—¶(00â€¦â€¦23)â˜…â˜…â˜…
%k å°æ—¶(0â€¦â€¦23)
%h å°æ—¶(01â€¦â€¦12) 
%I å°æ—¶(01â€¦â€¦12)
%l å°æ—¶(1â€¦â€¦12)
%i åˆ†é’Ÿ, æ•°å­—(00â€¦â€¦59) â˜…â˜…â˜… minite
%r æ—¶é—´,12 å°æ—¶(hh:mm:ss [AP]M)
%T æ—¶é—´,24 å°æ—¶(hh:mm:ss)
%S ç§’(00â€¦â€¦59)
%s ç§’(00â€¦â€¦59) â˜…â˜…â˜…
%p AMæˆ–PM
%w ä¸€ä¸ªæ˜ŸæœŸä¸­çš„å¤©æ•°(0=Sunday â€¦â€¦6=Saturday )
%U æ˜ŸæœŸ(0â€¦â€¦52), è¿™é‡Œæ˜ŸæœŸå¤©æ˜¯æ˜ŸæœŸçš„ç¬¬ä¸€å¤©,æŸ¥è¯¢æŒ‡å®šæ—¥æœŸå±äºå½“å‰å¹´ä»½çš„ç¬¬å‡ ä¸ªå‘¨ â˜…â˜…â˜…â˜…
%u æ˜ŸæœŸ(0â€¦â€¦52), è¿™é‡Œæ˜ŸæœŸä¸€æ˜¯æ˜ŸæœŸçš„ç¬¬ä¸€å¤©

# æ—¥æœŸé—´éš”
# é—´éš”å•ä½å¯ä»¥æ˜¯DAY MONTH MINUTE WEEK YEAR SECOND HOUR
SELECT DATE_ADD(NOW(),INTERVAL 2 DAY); # 2022-01-07 22:46:39
SELECT DATE_ADD(NOW(),INTERVAL 2 MONTH); # 2022-02-06 22:47:17
SELECT DATE_ADD('2022-02-06 22:47:17',INTERVAL 2 MONTH); # 2022-04-06 22:47:17
SELECT DATE_SUB(NOW(),INTERVAL 3 DAY); # 2022-01-03 22:49:24
SELECT DATE_SUB('2022-02-06 22:47:17',INTERVAL 2 MONTH); # 2021-12-06 22:47:17

# æ—¥æœŸç›¸å·®
select datediff('2022-01-06','2021-12-28'); -- 9
```

### çª—å£å‡½æ•°

```java
# çª—å£å‡½æ•°
èšåˆå‡½æ•° over(partition by åˆ—å order by åˆ—å rows between å¼€å§‹ and ç»“æŸ)
å½“å‰è¡Œ current row
å¾€å‰nè¡Œ n preceding
å¾€ånè¡Œ n following
åˆ†åŒºç¬¬ä¸€è¡Œ unbounded preceding
åˆ†åŒºæœ€åä¸€è¡Œ unbounded following

# æ—¶é—´èŒƒå›´
èšåˆå‡½æ•° over(partition by åˆ—å order by åˆ—å range interval 1 day)
```

### æ­£åˆ™è¡¨è¾¾å¼

```java
å­—æ®µ regexp è¡¨è¾¾å¼
```

- `^`ï¼šè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è¡Œçš„å¼€å¤´
- `[a-z]`ï¼šè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦èŒƒå›´ï¼ŒåŒ¹é…ä» a åˆ° z çš„ä»»ä½•å­—ç¬¦ã€‚
    - `[0-9]`ï¼šè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦èŒƒå›´ï¼ŒåŒ¹é…ä» 0 åˆ° 9 çš„ä»»ä½•å­—ç¬¦ã€‚
    - `[a-zA-Z]`ï¼šè¿™ä¸ªå˜é‡åŒ¹é…ä» a åˆ° z æˆ– A åˆ° Z çš„ä»»ä½•å­—ç¬¦ã€‚è¯·æ³¨æ„ï¼Œä½ å¯ä»¥åœ¨æ–¹æ‹¬å·å†…æŒ‡å®šçš„å­—ç¬¦èŒƒå›´çš„æ•°é‡æ²¡æœ‰é™åˆ¶ï¼Œæ‚¨å¯ä»¥æ·»åŠ æƒ³è¦åŒ¹é…çš„å…¶ä»–å­—ç¬¦æˆ–èŒƒå›´ã€‚
    - `[^a-z]`ï¼šè¿™ä¸ªå˜é‡åŒ¹é…ä¸åœ¨ a åˆ° z èŒƒå›´å†…çš„ä»»ä½•å­—ç¬¦ã€‚è¯·æ³¨æ„ï¼Œå­—ç¬¦ ^ ç”¨æ¥å¦å®šå­—ç¬¦èŒƒå›´ï¼Œå®ƒåœ¨æ–¹æ‹¬å·å†…çš„å«ä¹‰ä¸å®ƒçš„æ–¹æ‹¬å·å¤–è¡¨ç¤ºå¼€å§‹çš„å«ä¹‰ä¸åŒã€‚
- `[a-z]*`ï¼šè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦èŒƒå›´ï¼ŒåŒ¹é…ä» a åˆ° z çš„ä»»ä½•å­—ç¬¦ 0 æ¬¡æˆ–å¤šæ¬¡ã€‚
- `[a-z]+`ï¼šè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦èŒƒå›´ï¼ŒåŒ¹é…ä» a åˆ° z çš„ä»»ä½•å­—ç¬¦ 1 æ¬¡æˆ–å¤šæ¬¡ã€‚
- `.`ï¼šåŒ¹é…ä»»æ„ä¸€ä¸ªå­—ç¬¦ã€‚
- `\.`ï¼šè¡¨ç¤ºå¥ç‚¹å­—ç¬¦ã€‚è¯·æ³¨æ„ï¼Œåæ–œæ ç”¨äºè½¬ä¹‰å¥ç‚¹å­—ç¬¦ï¼Œå› ä¸ºå¥ç‚¹å­—ç¬¦åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­å…·æœ‰ç‰¹æ®Šå«ä¹‰ã€‚è¿˜è¦æ³¨æ„ï¼Œåœ¨è®¸å¤šè¯­è¨€ä¸­ï¼Œä½ éœ€è¦è½¬ä¹‰åæ–œæ æœ¬èº«ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨\\.ã€‚
- `$`ï¼šè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è¡Œçš„ç»“å°¾ã€‚

## å…³ç³»çš„èŒƒå¼

- 1NFï¼šåˆ—çš„åŸå­æ€§ï¼Œæ¯åˆ—éƒ½æ˜¯ä¸å¯å†åˆ†çš„æ•°æ®å•å…ƒï¼›
- 2NFï¼šæ¶ˆé™¤éƒ¨åˆ†ä¾èµ–ï¼Œé™¤äº†ä¸»é”®ä»¥å¤–çš„å…¶ä»–åˆ—éƒ½å®Œå…¨ä¾èµ–äºä¸»é”®ï¼›
- 3NFï¼šæ¶ˆé™¤ä¼ é€’ä¾èµ–ï¼Œå…¶ä»–åˆ—éƒ½ä¸ä¸»é”®ç›´æ¥ç›¸å…³ï¼Œç›¸äº’é—´æ²¡æœ‰ç›¸äº’ä¾èµ–å…³ç³»ã€‚

## æ•°æ®ç±»å‹

### charå’Œvarcharçš„åŒºåˆ«ï¼Ÿ

- charå­˜å‚¨å›ºå®šé•¿åº¦çš„å­—ç¬¦ï¼Œæœ€å¤§é•¿åº¦æ˜¯255ï¼Œä¸è¶³çš„ç”¨ç©ºæ ¼å¡«å……ï¼›varcharå­˜å‚¨å˜é•¿çš„å­—ç¬¦ï¼Œæœ€å¤§å­—èŠ‚æ•°æ˜¯65535ï¼Œå…¶ä¸­éœ€è¦1-2ä¸ªå­—èŠ‚è®°å½•æœ¬èº«é•¿åº¦ï¼Œå…è®¸ä¸ºnullçš„varcharè¿˜éœ€è¦1ä¸ªå­—èŠ‚æ ‡è¯†ã€‚
- charå­˜å–å¿«ï¼Œä½†å¯èƒ½ä¼šå æ®å¤šä½™çš„ç©ºé—´ï¼›varcharä¸å æ®å¤šä½™ç©ºé—´ä½†æ˜¯å­˜å–æ…¢ã€‚

### è®°å½•è´§å¸ç”¨ä»€ä¹ˆå­—æ®µç±»å‹ï¼Ÿ

ç”¨`Decimal`æˆ–è€…`Numeric`ï¼ŒDECIMAL å’Œ NUMERIC å€¼ä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨ï¼Œè€Œä¸æ˜¯ä½œä¸ºäºŒè¿›åˆ¶æµ®ç‚¹æ•°ï¼Œä»¥ä¾¿ä¿å­˜é‚£äº›å€¼çš„å°æ•°ç²¾åº¦ã€‚

### Mysqlæ€ä¹ˆå­˜å‚¨emojiï¼Ÿ

MySQL çš„ utf8 å­—ç¬¦é›†ä»…æ”¯æŒæœ€å¤š 3 ä¸ªå­—èŠ‚çš„ UTF-8 å­—ç¬¦ï¼Œä½†æ˜¯ emoji è¡¨æƒ…ï¼ˆğŸ˜Šï¼‰æ˜¯ 4 ä¸ªå­—èŠ‚çš„ UTF-8 å­—ç¬¦ï¼Œæ‰€ä»¥åœ¨ MySQL ä¸­å­˜å‚¨ emoji è¡¨æƒ…æ—¶ï¼Œéœ€è¦ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†ã€‚

## æ‰§è¡Œè®¡åˆ’

- ä½¿ç”¨`explain`æŸ¥çœ‹ã€‚
- å¸¸è§å­—æ®µï¼š
    - `type`ï¼šç´¢å¼•
        - `const`ï¼šæ ¹æ®ä¸»é”®æŸ¥è¯¢
        - `all`ï¼šå…¨è¡¨æ‰«æ
        - `index`ï¼šæŒ‰ç´¢å¼•é¡ºåºå…¨è¡¨æ‰«æ
        - `range`ï¼šæŒ‰ç´¢å¼•èŒƒå›´æŸ¥è¯¢
        - `ref`ï¼šéå”¯ä¸€ç´¢å¼•è¿”å›å¤šè¡Œæ•°æ®
        - `eq_ref`ï¼šå”¯ä¸€ç´¢å¼•è¿”å›ä¸€è¡Œæ•°æ®
    - `possible_keys`ï¼šå¯èƒ½ä½¿ç”¨çš„ç´¢å¼•
    - `key`ï¼šå®é™…ä½¿ç”¨çš„ç´¢å¼•
    - `key_len`ï¼šç´¢å¼•å­—æ®µé•¿åº¦
    - `extra`ï¼šæ‰§è¡Œæƒ…å†µçš„æè¿°å’Œè¯´æ˜
        - `using index`ï¼šä½¿ç”¨è¦†ç›–ç´¢å¼•
        - `using index condition`ï¼šä½¿ç”¨ç´¢å¼•ä¸‹æ¨ï¼ˆæ•°æ®å¼•æ“å±‚è¿‡æ»¤æ•°æ®ï¼‰
        - `using where`ï¼šé€šè¿‡whereæ¡ä»¶è¿‡æ»¤æ•°æ®ï¼ˆserverå±‚è¿‡æ»¤æ•°æ®ï¼‰
        - `using temporary`ï¼šæŸ¥è¯¢æ—¶ï¼Œç”¨ä¸´æ—¶è¡¨ä¿å­˜ç»“æœï¼Œæ•ˆç‡ä½
        - `using filesort`ï¼šåŒ…å«order byæ“ä½œä¸”æ— æ³•ä½¿ç”¨ç´¢å¼•æ’åºï¼Œæ•ˆç‡ä½

# SQLä¼˜åŒ–

## ä¼˜åŒ–ç­–ç•¥

1. **åˆç†ä½¿ç”¨æ•°æ®åº“åˆ†è¡¨**ï¼šå°†å†·å­—æ®µã€å¤§å­—æ®µå‚ç›´åˆ†è¡¨ï¼Œæé«˜çƒ­ç‚¹æ•°æ®çš„æŸ¥è¯¢æ•ˆç‡ï¼Œé¿å…IOäº‰æŠ¢å’Œé”è¡¨å‡ ç‡ã€‚
2. **ç´¢å¼•ä¼˜åŒ–**ï¼šåœ¨å¸¸ç”¨çš„å­—æ®µä¸Šå»ºç«‹ç´¢å¼•ï¼Œä½†è¦é¿å…è¿‡å¤šç´¢å¼•ã€‚[ç´¢å¼•ä¼˜åŒ–æ–¹æ³•](MySQL%2063748c5139f3404594dd27795d6cada0.md) 
3. **é¿å…ä½¿ç”¨`select *`**ï¼š
    1. å¢åŠ é¢„å¤„ç†å™¨çš„å¤„ç†æˆæœ¬ï¼›
    2. æ— ç”¨å­—æ®µå¢åŠ ç½‘ç»œæ—¶å»¶å’Œç£ç›˜IOï¼Ÿï¼›
    3. å‡ ä¹æ— æ³•è§¦å‘è¦†ç›–ç´¢å¼•ã€‚
4. **ä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹**ï¼š
    1. `varchar`é•¿åº¦åˆ†é…çœŸæ­£çš„ç©ºé—´ï¼›
    2. å°‘ä½¿ç”¨`null`ï¼Œå¾ˆéš¾æŸ¥è¯¢ä¼˜åŒ–ä¸”å é¢å¤–çš„ç´¢å¼•ç©ºé—´ï¼›
    3. ä½¿ç”¨æ•´å½¢ã€æšä¸¾æ›¿æ¢å­—ç¬¦å‹ç­‰ã€‚

## æ…¢æŸ¥è¯¢

æ•°æ®åº“æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šçš„è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤10ç§’ï¼‰æ—¶ï¼Œç§°ä¸ºæ…¢æŸ¥è¯¢ã€‚

åŸå› ï¼š

- æŸ¥è¯¢è¯­å¥å¤æ‚
- æŸ¥è¯¢æ•°æ®é‡å¤§
- ç¼ºå°‘ç´¢å¼•
- ç¡¬ä»¶èµ„æºä¸è¶³

ä¼˜åŒ–æ–¹æ³•ï¼š

- å®šä½æ…¢sqlï¼šå¼€å¯æ…¢æŸ¥è¯¢ï¼Œé€šè¿‡æ—¥å¿—å®šä½æ…¢sql
- åˆ†æï¼šç”¨`explain`åˆ†æå…·ä½“çš„sqlè¯­å¥
- åˆ¤æ–­ç´¢å¼•æ˜¯å¦å¤±æ•ˆã€é€‰æ‹©æ›´å¥½çš„ç´¢å¼•ã€ä½¿ç”¨æ›´ä¼˜åŒ–çš„æŸ¥è¯¢è¯­å¥

> é¦–å…ˆï¼Œå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œè®¾ç½®é˜ˆå€¼ï¼Œé€šè¿‡æ—¥å¿—å®šä½æ…¢sqlã€‚ç„¶åè¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœè¡¨æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œä¼˜å…ˆè€ƒè™‘ç´¢å¼•ä¼˜åŒ–ï¼Œæå‡æŸ¥è¯¢çš„æ•ˆç‡ï¼Œæ¯”å¦‚è¦†ç›–ç´¢å¼•ã€å‰ç¼€ç´¢å¼•ã€å¯¹æ’åºçš„åˆ†ç»„çš„å­—æ®µæ·»åŠ ç´¢å¼•ç­‰ã€‚å¦‚æœè¿˜æ˜¯æ¯”è¾ƒæ…¢ï¼Œå°±å¾—åˆ†ææ‰§è¡Œçš„æƒ…å†µï¼Œå¯ä»¥ç”¨explainå…³é”®å­—æ¥åˆ†æï¼Œä¸»è¦çœ‹typeå­—æ®µçœ‹ç´¢å¼•æ˜¯å¦å¤±æ•ˆç­‰æƒ…å†µã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è€ƒè™‘å…¶ä»–çš„æ–¹é¢æ¯”å¦‚è¿æ¥æ—¶æ˜¯å¦å°è¡¨é©±åŠ¨å¤§è¡¨ã€æ˜¯ä¸æ˜¯åˆ†é¡µå¯¼è‡´çš„æ€§èƒ½é—®é¢˜ç­‰ã€‚æœ€åï¼Œé™¤äº†sqlä¸Šä¼˜åŒ–ï¼Œè¿˜å¯ä»¥é€šè¿‡æ•°æ®ç¼“å­˜ã€åˆ†åº“åˆ†è¡¨æ¥æ”¹å–„ã€‚
> 

å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š

```
show variables like '%slow_query_log%'
set global slow_query_log=1;
```

# ç´¢å¼•

## ç´¢å¼•æ¦‚å¿µ

- ç´¢å¼•æ˜¯ä¸€ç§èƒ½æé«˜æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡çš„æ•°æ®ç»“æ„ã€‚
- ç´¢å¼•ä¸€èˆ¬å­˜å‚¨åœ¨ç£ç›˜çš„æ–‡ä»¶ä¸­ï¼Œå®ƒæ˜¯å ç”¨ç‰©ç†ç©ºé—´çš„ã€‚

## ç´¢å¼•ç±»å‹

### æŒ‰æ•°æ®ç»“æ„

- B+æ ‘ç´¢å¼•ï¼šåªåœ¨å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œä¸”å¶å­èŠ‚ç‚¹é‡‡ç”¨åŒé“¾è¡¨ï¼Œé€‚åˆåŸºäºèŒƒå›´çš„æŸ¥æ‰¾ã€‚
- Hashç´¢å¼•ï¼šæ— åºï¼Œæ’å…¥å’Œç­‰å€¼æŸ¥è¯¢æ•ˆç‡é«˜ï¼ŒèŒƒå›´æŸ¥è¯¢æ•ˆç‡ä½ã€‚
1. **InnoDBä¸ºä»€ä¹ˆä½¿ç”¨B+æ ‘ï¼Ÿ**
    1. äºŒå‰æŸ¥æ‰¾æ ‘ï¼šä¸å¹³è¡¡
    2. å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼ˆAVLï¼‰ï¼šåœ¨æ’å…¥åˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™æ•ˆç‡ä½
    3. çº¢é»‘æ ‘ï¼šä¸æ“…é•¿åœ¨ç£ç›˜è®¾å¤‡ä¸­çš„æƒ…å†µï¼Œå› ä¸ºæ ‘å¤ªé«˜äº†ï¼Œå¢åˆ æ”¹æŸ¥éœ€è¦çš„ç£ç›˜I/Oä¹Ÿå¤šï¼Œä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚
    4. B+æ ‘ï¼š
        1. ç›¸å¯¹äºBæ ‘ï¼Œä»…åœ¨å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªæ”¾ç´¢å¼•ï¼Œæ¯ä¸ªç£ç›˜å—èƒ½å­˜æ”¾æ›´å¤šç´¢å¼•ï¼Œä½¿B+æ ‘çŸ®èƒ–ï¼ŒI/Oæ›´å°‘ã€‚
        2. B+æ ‘æœ‰å¤§é‡å†—ä½™çš„èŠ‚ç‚¹ï¼ˆæ‰€æœ‰éå¶å­èŠ‚ç‚¹éƒ½æ˜¯å†—ä½™èŠ‚ç‚¹ï¼‰ï¼Œåœ¨æ’å…¥å’Œåˆ é™¤çš„æ—¶å€™ä¸ä¼šå‘ç”Ÿæ ‘å‹çš„å˜åŒ–ï¼Œæ•ˆç‡æ›´é«˜ã€‚
        3. å¶å­èŠ‚ç‚¹é‡‡ç”¨åŒé“¾è¡¨è¿æ¥ï¼Œæœ‰åˆ©äºèŒƒå›´æŸ¥è¯¢ã€‚

### æŒ‰ç‰©ç†å­˜å‚¨

- èšç°‡ç´¢å¼•ï¼ˆä¸»é”®ç´¢å¼•ï¼‰ï¼šå¶å­èŠ‚ç‚¹å­˜æ”¾å®é™…çš„å®Œæ•´æ•°æ®ï¼Œä¸€èˆ¬ä¸ºä¸»é”®ã€‚
- éèšç°‡ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰ï¼šå¶å­èŠ‚ç‚¹å­˜æ”¾ç´¢å¼•åˆ—å’Œä¸»é”®å€¼ã€‚
1. **å›è¡¨**
    
    é€šè¿‡äºŒçº§ç´¢å¼•æŸ¥æ‰¾æ•°æ®ï¼Œè·å–ä¸»é”®å†ä»ä¸»é”®ç´¢å¼•æ ‘ç§è·å–æ•°æ®çš„è¿‡ç¨‹ã€‚
    
2. **è¦†ç›–ç´¢å¼•**
    
    é€šè¿‡äºŒçº§ç´¢å¼•å°±èƒ½å¤ŸæŸ¥è¯¢åˆ°æ•°æ®ï¼Œä¸éœ€è¦å›è¡¨ã€‚
    

### æŒ‰ç…§é€»è¾‘ç»´åº¦

- ä¸»é”®ç´¢å¼•ï¼šä¸å…è®¸null
- æ™®é€šç´¢å¼•
- å”¯ä¸€ç´¢å¼•
- å•åˆ—ç´¢å¼•
- è”åˆç´¢å¼•
1. **ç´¢å¼•ä¸‹æ¨**
    
    å°†æ¡ä»¶åˆ¤æ–­ç”±serverå±‚ä¸‹æ¨åˆ°æ•°æ®å¼•æ“å±‚ï¼Œæ ¹æ®è”åˆç´¢å¼•ä¸­çš„å­—æ®µè¿›è¡Œåˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ“ä½œã€‚
    
2. **æœ€å·¦åŒ¹é…åŸåˆ™**
    - æŸ¥è¯¢æ¡ä»¶ä¸­çš„åˆ—éœ€è¦ä»è”åˆç´¢å¼•æœ€å·¦è¾¹çš„åˆ—å¼€å§‹ï¼Œå¹¶ä¸”ä¸èƒ½è·³è¿‡ä¸­é—´çš„åˆ—ã€‚
    - é‡åˆ°èŒƒå›´æŸ¥è¯¢æ—¶åœæ­¢åŒ¹é…ï¼ŒèŒƒå›´æŸ¥è¯¢ä¹‹åçš„å­—æ®µæ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚

## ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

### ç´¢å¼•çš„ä¼˜ç¼ºç‚¹

1. ä¼˜ç‚¹ï¼š
    - æé«˜æŸ¥è¯¢æ•ˆç‡
2. ç¼ºç‚¹ï¼š
    - ç´¢å¼•å ç”¨ç‰©ç†ç©ºé—´
    - ç´¢å¼•çš„åˆ›å»ºå’Œç»´æŠ¤éœ€è¦æ¶ˆè€—æ—¶é—´ï¼Œé™ä½sqlçš„æ‰§è¡Œæ•ˆç‡

### ç´¢å¼•åº”ç”¨åœºæ™¯

1. é€‚åˆåˆ›å»ºç´¢å¼•çš„åœºæ™¯ï¼š
    1. ç»å¸¸æŸ¥è¯¢çš„æˆ–æœ‰å”¯ä¸€æ€§è¦æ±‚çš„åˆ—
    2. å¸¸ç”¨äºæ’åºæˆ–åˆ†ç»„çš„è¡¨ï¼ˆgroup by/order byï¼‰
    3. æ•°æ®é‡å¤§çš„è¡¨
        
        è¶…å¤§è¡¨å¦‚ä½•æ·»åŠ ç´¢å¼•ï¼Œæ·»åŠ ç´¢å¼•ä¼šåŠ é”ï¼Ÿ
        
        1. å…ˆåˆ›å»ºä¸€å¼ è·ŸåŸè¡¨`A`æ•°æ®ç»“æ„ç›¸åŒçš„æ–°è¡¨`B`ã€‚
        2. åœ¨æ–°è¡¨`B`æ·»åŠ éœ€è¦åŠ ä¸Šçš„æ–°ç´¢å¼•ã€‚
        3. æŠŠåŸè¡¨`A`æ•°æ®å¯¼åˆ°æ–°è¡¨`B`
        4. `rename`æ–°è¡¨`B`ä¸ºåŸè¡¨çš„è¡¨å`A`ï¼ŒåŸè¡¨`A`æ¢åˆ«çš„è¡¨åï¼›
2. ä¸é€‚åˆåˆ›å»ºç´¢å¼•çš„åœºæ™¯ï¼š
    1. æ•°æ®é‡å°‘çš„è¡¨
    2. å¾ˆå°‘æŸ¥è¯¢æˆ–æ›´æ–°æ¯”è¾ƒé¢‘ç¹çš„å­—æ®µ
    3. åŒºåˆ†åº¦ä½çš„å­—æ®µï¼ˆå¦‚æ€§åˆ«ï¼Œåªæœ‰ä¸¤ç§å–å€¼ï¼‰

### ç´¢å¼•å¤±æ•ˆçš„åœºæ™¯

1. ä½¿ç”¨å·¦æ¨¡ç³ŠåŒ¹é…æˆ–å·¦å³æ¨¡ç³ŠåŒ¹é…
2. è¿èƒŒäº†æœ€å·¦åŒ¹é…åŸåˆ™
3. åœ¨ç´¢å¼•åˆ—ä¸­ä½¿ç”¨è®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢æ“ä½œ
4. whereæ¡ä»¶ä¸­orå‰é¢æ˜¯ç´¢å¼•ï¼Œåé¢ä¸æ˜¯ç´¢å¼•
5. mysql ä¼°è®¡ä½¿ç”¨å…¨è¡¨æ‰«æè¦æ¯”ä½¿ç”¨ç´¢å¼•å¿«ï¼Œåˆ™ä¸ä½¿ç”¨ç´¢å¼•
6. ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨`is nullã€is not null`ï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆ

### ç´¢å¼•ä¼˜åŒ–æ–¹æ³•

1. å‰ç¼€ç´¢å¼•ä¼˜åŒ–ï¼šå‡å°‘ç´¢å¼•é¡¹çš„å¤§å°
2. è¦†ç›–ç´¢å¼•ä¼˜åŒ–ï¼šè”åˆç´¢å¼•é¿å…å›è¡¨æ“ä½œï¼Œå‡å°‘IO
3. ä¸»é”®ç´¢å¼•æœ€å¥½è‡ªå¢ï¼šæ’å…¥æ–°çºªå½•ä¸ä¼šé€ æˆé¡µåˆ†è£‚
4. é¿å…è¿‡å¤šçš„ç´¢å¼•

# äº‹åŠ¡ä¸é”

## äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ACIDä»¥åŠå®ç°æ–¹å¼ï¼Ÿ

- åŸå­æ€§Atomicity
    - æ‰€æœ‰çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆéƒ½ä¸å®Œæˆï¼Œä¸å­˜åœ¨ä¸­é—´çŠ¶æ€ã€‚
    - é€šè¿‡Undo logå®ç°
- ä¸€è‡´æ€§Consistency
    - äº‹åŠ¡å‰åæ•°æ®æ»¡è¶³å®Œæ•´æ€§çº¦æŸï¼Œæ•°æ®åº“ä¿æŒä¸€è‡´çŠ¶æ€ã€‚
    - é€šè¿‡å…¶ä»–ä¸‰ä¸ªç‰¹æ€§ä¿è¯
- éš”ç¦»æ€§Isolation
    - å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œï¼Œäº‹åŠ¡ä¹‹é—´ä¸èƒ½æœ‰å¹²æ‰°ã€‚
    - é€šè¿‡MVCCå’Œé”å®ç°
- æŒä¹…æ€§Durability
    - äº‹åŠ¡ä¸€æ—¦è¢«æäº¤åˆ™ç»“æœæ°¸è¿œä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±
    - é€šè¿‡redo logå®ç°

## å¹¶è¡Œäº‹åŠ¡ä¼šé€ æˆå“ªäº›é—®é¢˜ï¼Ÿ

- è„è¯»ï¼šè¯»åˆ°å…¶ä»–äº‹åŠ¡æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œå¯¹æ–¹å¯èƒ½å›æ»š
- ä¸å¯é‡å¤è¯»ï¼šåŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå‰åä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸ä¸€è‡´
- å¹»è¯»ï¼šåŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå‰åè¯»å–çš„æ•°æ®è®°å½•æ•°é‡ä¸ä¸€è‡´

## å››ç§éš”ç¦»çº§åˆ«ï¼Ÿ

- ä¸²è¡ŒåŒ–ï¼šåŠ è¯»å†™é”ã€‚
- å¯é‡å¤è¯»ï¼šäº‹åŠ¡æ‰§è¡Œä¸­çš„æ•°æ®ä¸å¯åŠ¨æ—¶ä¸€è‡´ï¼ŒInnoDBé»˜è®¤çš„éš”ç¦»çº§åˆ«ã€‚
- è¯»æäº¤ï¼šäº‹åŠ¡æäº¤åï¼Œå˜æ›´è¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚
- è¯»æœªæäº¤ï¼šäº‹åŠ¡æ²¡æäº¤å˜æ›´å°±è¢«çœ‹åˆ°ã€‚

![4e98ea2e60923b969790898565b4d643.webp](MySQL%2063748c5139f3404594dd27795d6cada0/4e98ea2e60923b969790898565b4d643.webp)

## é”çš„ç±»å‹æœ‰å“ªäº›ï¼Ÿ

### å…¨å±€é”

å¯¹æ•°æ®åº“åŠ é”ï¼Œä¸€èˆ¬ç”¨äºå…¨åº“é€»è¾‘å¤‡ä»½ã€‚

### è¡¨çº§é”

- è¡¨é”ï¼š`lock tables â€¦ read/write` ã€‚
- å…ƒæ•°æ®é”ï¼šä¸æ˜¾å¼ä½¿ç”¨ï¼Œé˜²æ­¢è¿›è¡ŒCRUDæ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯¹è¡¨ç»“æ„è¿›è¡Œæ”¹å˜ã€‚
- æ„å‘é”ï¼šå¿«é€Ÿåˆ¤æ–­è¡¨é‡Œæ˜¯å¦æœ‰è®°å½•è¢«åŠ é”ï¼Œå¦åˆ™ä¸€è¡Œä¸€è¡Œæ£€æŸ¥æ•ˆç‡ä½ã€‚
- Auto-incé”ï¼šä¿è¯å­—æ®µè¿ç»­è‡ªå¢ã€‚

### è¡Œçº§é”

- Read Lockï¼šè®°å½•é”
- Gap Lockï¼šé—´éš™é”ï¼Œé—´éš™é”Sé”å’ŒXé”æ²¡æœ‰åŒºåˆ†ï¼Œæ²¡æœ‰äº’æ–¥å…³ç³»ï¼Œä¼šäº§ç”Ÿæ­»é”é—®é¢˜
- Next-key Lockï¼šä¸´é”®é”
- æ’å…¥æ„å‘é”ï¼šæ’å…¥æ—¶æœ‰Gap Locké˜»å¡ï¼Œä¼šäº§ç”Ÿæ’å…¥æ„å‘é”

## è¿é—®ä¸²çƒ§

### ä¸ºä»€ä¹ˆä¼šå‡ºç°å¹»è¯»ï¼Ÿ

è¡Œé”åªèƒ½é”ä½å­˜åœ¨çš„è®°å½•ï¼Œåœ¨è¯»å–æ•°æ®å‰åæœ‰äº‹åŠ¡æ’å…¥äº†æ•°æ®ã€‚

### å¹»è¯»ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ

ç ´ç¯äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œé”çš„è¯­ä¹‰ï¼ˆé”æ²¡å…¨é”ä½ï¼‰ã€‚

### æ€ä¹ˆé¿å…å¹»è¯»ï¼Ÿ

InnoDBåœ¨RRçº§åˆ«é€šè¿‡å¼•å…¥é—´éš™é”é¿å…å¹»è¯»ã€‚

- é’ˆå¯¹å¿«ç…§è¯»ï¼ŒMVCCåœ¨æ‰§è¡Œç¬¬ä¸€ä¸ªæŸ¥è¯¢è¯­å¥æ—¶ä¼šç”ŸæˆRead Viewï¼Œåç»­çš„æŸ¥è¯¢éƒ½åˆ©ç”¨è¯¥Read Viewï¼Œä¸ä¼šå‡ºç°å¹»è¯»é—®é¢˜ã€‚
- é’ˆå¯¹å½“å‰è¯»ï¼Œç”±äºä¼šæ‹‰å–æœ€æ–°çš„æ•°æ®ï¼Œä¼šå‡ºç°å¹»è¯»ã€‚InnoDBå¼•å…¥é—´éš™é”ï¼Œåœ¨æ‰§è¡Œè¯­å¥æ—¶å¢åŠ ä¸´é”®é”ï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½åœ¨æŸ¥è¯¢çš„æ•°æ®èŒƒå›´å†…å¢åŠ æ•°æ®ã€‚å°½ç®¡ä»ç„¶å­˜åœ¨å¹»è¯»çš„ç‰¹æ®Šæƒ…å†µï¼Œèƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šé¿å…å¹»è¯»ã€‚ä¸ºäº†ä¿è¯é«˜å¹¶å‘æƒ…å†µä¸‹å‡ºé”™ï¼Œå»ºè®®åœ¨å¼€å¯äº‹åŠ¡åç«‹å³`select â€¦ for update`é”ä½è®°å½•ã€‚

### é—´éš™é”ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿæ­»é”ï¼Ÿ

é—´éš™é”æ²¡æœ‰Sé”å’ŒXé”ä¹‹åˆ†ï¼Œé”ä¹‹é—´æ²¡æœ‰äº’æ–¥ã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡å…ˆåˆ†åˆ«å¯¹é—´éš™åŠ é”ï¼Œå†ä¾æ¬¡åœ¨é—´éš™æ’å…¥æ•°æ®å°±ä¼šé€ æˆæ­»é”ã€‚

- Sé”ï¼šå…±äº«é”ï¼Œé”å®šçš„èµ„æºå¯ä»¥è¢«ç”¨æˆ·è¯»å–ä½†ä¸èƒ½ä¿®æ”¹ã€‚
- Xé”ï¼šç‹¬å é”ï¼Œé”å®šçš„èµ„æºä¸èƒ½è¢«è¯»æˆ–ä¿®æ”¹ã€‚

### æ€ä¹ˆè§£å†³æ­»é”ï¼Ÿ

1. è®¾ç½®äº‹åŠ¡ç­‰å¾…é”çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åˆ™å›æ»šï¼›
2. å¼€å¯æ•°æ®åº“ä¸»åŠ¨æ­»é”æ£€æŸ¥ï¼Œå‘ç°æ­»é”åå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡è‡ªåŠ¨å›æ»šã€‚

### InnoDBæ€ä¹ˆå®ç°è¯»æäº¤ï¼Ÿ

åŒæ ·é€šè¿‡MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰å®ç°ï¼ŒMVCCç”±Read Viewå’ŒUndo logå®ç°ï¼š

- è¯»æäº¤åœ¨æ¯æ¬¡è¯»å–æ•°æ®æ—¶éƒ½ç”ŸæˆRead Viewï¼›
- å¯é‡å¤è¯»åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºRead Viewï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡æœŸé—´ä½¿ç”¨åŒä¸€ä¸ªRead Viewï¼ˆå¯¹äºå¿«ç…§è¯»ï¼‰ã€‚

### MVCCå·¥ä½œåŸç†ï¼Ÿ

Read Viewè®°å½•äº†4ä¸ªå­—æ®µï¼šäº‹åŠ¡idã€æ´»è·ƒçš„äº‹åŠ¡idåˆ—è¡¨ã€æ´»è·ƒçš„æœ€å°äº‹åŠ¡idä»¥åŠä¸‹ä¸€ä¸ªäº‹åŠ¡çš„idã€‚æŸ¥çœ‹æ•°æ®æ—¶ï¼Œæ¯”è¾ƒundo logè®°å½•ä¸­çš„éšè—å­—æ®µï¼Œå¦‚æœè®°å½•ä¸å¯è§é¡ºç€æŒ‡é’ˆå¾€ä¹‹å‰çš„ç‰ˆæœ¬å›æº¯ã€‚

- å¦‚æœä¿®æ”¹è®°å½•çš„äº‹åŠ¡idæ¯”æœ€å°æ´»è·ƒäº‹åŠ¡idå°ï¼Œåˆ™è¯¥è¡Œè®°å½•å¯è§ï¼›
- å¦‚æœä¿®æ”¹è®°å½•çš„äº‹åŠ¡idæ¯”ä¸‹ä¸€ä¸ªäº‹åŠ¡idå¤§ï¼Œåˆ™è¯¥è¡Œè®°å½•ä¸å¯è§ï¼›
- å¦‚æœå½“å‰è®°å½•çš„äº‹åŠ¡idåœ¨æ´»è·ƒåˆ—è¡¨ä¸­ï¼Œåˆ™å¯è§ã€‚

![RECTIFY_IMG_20240605_145545.jpg](MySQL%2063748c5139f3404594dd27795d6cada0/RECTIFY_IMG_20240605_145545.jpg)

### ä¸ºä»€ä¹ˆRRèƒ½å®ç°å¯é‡å¤è¯»è€ŒRCä¸è¡Œï¼Ÿ

1. å¿«ç…§è¯»ï¼šRRåœ¨äº‹åŠ¡ä¸­ä½¿ç”¨åŒä¸€ä¸ªRVï¼Œè€ŒRCåœ¨æ¯æ¬¡è¯»æ•°æ®å‰ä¼šæ›´æ–°RVï¼›
2. å½“å‰è¯»ï¼šRRé€šè¿‡next-key lockåŠ é”ï¼ŒRCæ²¡æœ‰gap lockï¼Œæ‰€ä»¥ä¸è¡Œã€‚

### ä»€ä¹ˆæ˜¯è„é¡µï¼Ÿ

å†…å­˜æ•°æ®é¡µå’Œç£ç›˜æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´ï¼Œç§°å†…å­˜é¡µä¸ºâ€œè„é¡µâ€ã€‚InnoDBé€šè¿‡AWLæŠ€æœ¯ç­‰å¾…åˆé€‚æ—¶é—´å°†è„é¡µå†™å…¥ç£ç›˜ã€‚

### æ‚²è§‚é”å’Œä¹è§‚é”çš„åŸç†å’Œä½¿ç”¨åœºæ™¯ï¼Ÿ

1. ä¹è§‚é”è®¤ä¸ºå¯¹åŒä¸€æ•°æ®çš„å¹¶å‘æ“ä½œä¸ä¼šæ€»å‘ç”Ÿï¼Œå±äºå°æ¦‚ç‡äº‹ä»¶ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å¯¹æ•°æ®ä¸Šé”ï¼Œä¹Ÿå°±æ˜¯ä¸é‡‡ç”¨æ•°æ®åº“è‡ªèº«çš„é”æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡ç¨‹åºæ¥å®ç°ã€‚æ¯”å¦‚é‡‡ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ–æ—¶é—´æˆ³æœºåˆ¶ã€‚
2. æ‚²è§‚é”å¯¹æ•°æ®è¢«å…¶ä»–æ•°æ®ä¿®æ”¹æŒä¿å®ˆæ€åº¦ï¼Œä¼šé€šè¿‡æ•°æ®åº“è‡ªèº«çš„é”æœºåˆ¶æ¥å®ç°ï¼Œä»è€Œä¿è¯æ•°æ®æ“ä½œçš„æ’å®ƒæ€§ã€‚

ä½¿ç”¨åœºæ™¯ï¼š

1. ä¹è§‚é”ï¼šè¯»å¤šå†™å°‘åœºæ™¯ï¼Œèƒ½æé«˜å¹¶å‘æ€§èƒ½ï¼›
2. æ‚²è§‚é”ï¼šå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œé˜²æ­¢äº‹åŠ¡ä¹‹é—´ç›¸äº’å½±å“ã€‚

# æ—¥å¿—

## MySQLæœ‰å“ªäº›æ—¥å¿—ï¼Ÿ

- undo logï¼šåœ¨æ•°æ®å¼•æ“å±‚ç”Ÿæˆã€‚åœ¨DBæ›´æ–°æ—¶è®°å½•ï¼Œä¸»è¦ç”¨äºäº‹åŠ¡å›æ»šå’ŒMVCCã€‚
- redo logï¼šåœ¨æ•°æ®å¼•æ“å±‚ç”Ÿæˆã€‚ç‰©ç†æ—¥å¿—ï¼Œè®°å½•å¯¹æ•°æ®é¡µçš„ä¿®æ”¹ï¼Œä¸»è¦ç”¨äºå´©æºƒæ¢å¤ã€‚
- bin logï¼šåœ¨serverå±‚ç”Ÿæˆã€‚è®°å½•äº†æ‰€æœ‰ä¿®æ”¹æ•°æ®åº“çŠ¶æ€çš„ SQL è¯­å¥ï¼Œä»¥åŠæ¯ä¸ªè¯­å¥çš„æ‰§è¡Œæ—¶é—´ï¼Œå¦‚ INSERTã€UPDATEã€DELETE ç­‰ï¼Œä¸»è¦ç”¨äºä¸»ä»å¤åˆ¶ç­‰ã€‚

### undo logå’Œredo logçš„åŒºåˆ«ï¼Ÿ

- undo logè®°å½•æ•°æ®æ›´æ–°å‰çš„çŠ¶æ€ï¼Œåœ¨äº‹åŠ¡æäº¤å‰å´©æºƒæ—¶æ¢å¤ã€‚
- redo logè®°å½•æ•°æ®æ›´æ–°åçš„çŠ¶æ€ï¼Œåœ¨äº‹åŠ¡æäº¤åå´©æºƒæ—¶æ¢å¤ã€‚

### redo logå’Œbin logçš„åŒºåˆ«ï¼Ÿ

- é€‚ç”¨å¯¹è±¡
    - redo logåœ¨æ•°æ®å¼•æ“å±‚ç”Ÿæˆï¼ŒInnoDBå¯ç”¨ï¼›
    - bin logåœ¨serverå±‚ç”Ÿæˆï¼Œä»»ä½•æ•°æ®å¼•æ“å‡å¯ç”¨ã€‚
- æ–‡ä»¶æ ¼å¼
    - redo logæ˜¯ç‰©ç†æ—¥å¿—
    - bin logæœ‰ä¸‰ç§æ ¼å¼ï¼ŒåŒ…æ‹¬ï¼š
        - statementï¼Œè®°å½•é€»è¾‘æ“ä½œï¼Œæœ‰åŠ¨æ€å‡½æ•°é—®é¢˜ï¼ˆå¦‚å¤„ç†å½“å‰æ—¶é—´ï¼‰ï¼›
        - rowï¼Œè®°å½•æ•°æ®æœ€ç»ˆè¢«ä¿®æ”¹çš„æ ·å­ï¼Œæ–‡ä»¶å¤§ï¼›
        - mixedï¼Œè‡ªåŠ¨é€‰æ‹©ä»¥ä¸Šä¸¤ç§æ ¼å¼ã€‚
- å†™å…¥æ–¹å¼
    - redo logæ˜¯å¾ªç¯å†™ï¼Œæ—¥å¿—ç©ºé—´å¤§å°å›ºå®šï¼Œåˆ·ç›˜çš„æ•°æ®ä¼šè¢«æ“¦é™¤ï¼›
    - bin logæ˜¯è¿½åŠ å†™ï¼Œå†™æ»¡æ–‡ä»¶ä¼šåˆ›å»ºæ–°æ–‡ä»¶ã€‚
- ç”¨é€”
    - redo logç”¨äºæ‰ç”µæ¢å¤ç­‰åœºæ™¯ï¼›
    - bin logç”¨äºä¸»ä»å¤åˆ¶ã€å¤‡ä»½æ¢å¤ç­‰åœºæ™¯ã€‚

### æœ‰äº†redo logä¸ºä»€ä¹ˆè¿˜è¦bin logï¼Ÿ

1. binlog ä¸çŸ¥é“æ•°æ®åº“ç©¶ç«Ÿæ˜¯åœ¨å“ªä¸€æ—¶åˆ»ä¸¢å¤±äº†å“ªéƒ¨åˆ†æ•°æ®ï¼Œåªèƒ½ä»å¤‡ä»½ç‚¹å¼€å§‹å¯¹ binlog è®°å½•é‡æ”¾æ¥æ¢å¤æ•°æ®ï¼Œæ¯”è¾ƒè€—æ—¶ã€‚
2. binlog æ˜¯æœåŠ¡å™¨å±‚é¢çš„åŠŸèƒ½ï¼Œredo log æ˜¯ innoDB çš„åŠŸèƒ½ã€‚redo log å¸®åŠ© InnoDB å®ç°äº†æ€§èƒ½æå‡ã€è‡ªåŠ¨æ¢å¤ã€‚ä½†å…¶ä»–å­˜å‚¨å¼•æ“æ˜¯æ— æ³•ä½¿ç”¨ redo log çš„èƒ½åŠ›çš„ã€‚

## åˆ·ç›˜æ—¶æœº

### redo logçš„åˆ·ç›˜æ—¶æœºï¼Ÿ

- MySQLå…³é—­çš„æ—¶å€™ï¼›
- å†™å…¥é‡å¤§äºredo log bufferä¸€åŠçš„æ—¶å€™ï¼›
- æ ¹æ®è®¾ç½®`innodb_flush_log_at_trx_commit` ã€‚
    
    ![innodb_flush_log_at_trx_commit2.drawio.webp](MySQL%2063748c5139f3404594dd27795d6cada0/innodb_flush_log_at_trx_commit2.drawio.webp)
    

### bin log çš„åˆ·ç›˜æ—¶æœºï¼Ÿ

![binlogcache.drawio.webp](MySQL%2063748c5139f3404594dd27795d6cada0/binlogcache.drawio.webp)

MySQLæä¾›ä¸€ä¸ª`sync_binlog` å‚æ•°æ¥æ§åˆ¶æ•°æ®åº“çš„ binlog åˆ·åˆ°ç£ç›˜ä¸Šçš„é¢‘ç‡ï¼š

- sync_binlog = 0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½åª writeï¼Œä¸ fsyncï¼Œåç»­äº¤ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼›
- sync_binlog = 1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼š writeï¼Œç„¶åé©¬ä¸Šæ‰§è¡Œ fsyncï¼›
- sync_binlog =N(N>1) çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ writeï¼Œä½†ç´¯ç§¯ N ä¸ªäº‹åŠ¡åæ‰ fsyncã€‚

## ä¸¤é˜¶æ®µæäº¤

### ä¸ºä»€ä¹ˆéœ€è¦ä¸¤é˜¶æ®µæäº¤ï¼Ÿ

redo logå½±å“ä¸»æ•°æ®åº“ï¼Œbin logå½±å“ä»æ•°æ®åº“ï¼Œå¦‚æœä¸€ä¸ªä¿å­˜å®Œäº†ï¼Œå¦ä¸€ä¸ªæ²¡æœ‰ä¿å­˜å®Œç³»ç»Ÿå°±å´©æºƒäº†ï¼Œä¼šå¯¼è‡´ä¸»æ•°æ®åº“å’Œå­æ•°æ®åº“ï¼ˆæˆ–å¤‡ä»½æ•°æ®ï¼‰æ•°æ®ä¸ä¸€è‡´ã€‚

### æ‰§è¡Œä¸€æ¡Updateè¯­å¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

1. æŸ¥è¯¢ä¸ä¿®æ”¹æ•°æ®ï¼Œç”Ÿæˆæ—¥å¿—ï¼š
    1. æ•°æ®å¼•æ“å…ˆæŸ¥å‡ºæ•°æ®ï¼Œå¦‚æœä¸åœ¨buffer poolä¸­å°±ä»ç£ç›˜ä¸­è¯»å…¥ï¼Œå¦åˆ™ç›´æ¥å°†æ•°æ®è¿”å›ï¼›
    2. æ‰§è¡Œå™¨è®¤ä¸ºéœ€è¦å¯¹æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œè°ƒç”¨æ•°æ®å¼•æ“æ¥å£å†™å…¥æ–°æ•°æ®ï¼›
    3. InnoDBç”Ÿæˆundo logï¼ˆæ—§æ•°æ®ï¼‰ï¼Œä¿®æ”¹buffer poolä¸­çš„undoé¡µï¼Œå¹¶å°†å¯¹undoé¡µçš„ä¿®æ”¹ä»¥redo logçš„æ–¹å¼è®°å½•ï¼ˆå†™å…¥log bufferä¸­çš„redo log bufferï¼‰ã€‚
    4. æ›´æ–°æ•°æ®ï¼ˆä¿®æ”¹buffer poolä¸­çš„æ•°æ®é¡µï¼‰åè®°å½•redo logã€‚
        
        > æ— è®ºæ˜¯undoé¡µçš„æ•°æ®è¿˜æ˜¯æ•°æ®é¡µçš„æ•°æ®ï¼Œéƒ½ä¼šç”±åå°å†³å®šä»€ä¹ˆæ—¶å€™å†™å…¥ç£ç›˜ï¼Œå³WALæŠ€æœ¯ã€‚
        > 
    5. æ‰§è¡Œå™¨ç”Ÿæˆè¿™ä¸ªæ“ä½œçš„bin logï¼Œå†™å…¥æ‰§è¡Œçº¿ç¨‹çš„binlog cacheä¸­ã€‚
2. äº‹åŠ¡æäº¤åï¼Œæ‰§è¡Œ**ä¸¤é˜¶æ®µæäº¤**ï¼š
    1. prepareé˜¶æ®µï¼šå°†XAå†…éƒ¨äº‹åŠ¡IDå†™åˆ°redo logï¼Œå°†äº‹åŠ¡çŠ¶æ€è®¾ä¸ºprepareï¼ŒæŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼›
    2. commité˜¶æ®µï¼šå°†XAäº‹åŠ¡IDå†™åˆ°bin logï¼Œç„¶åæŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå†å°†redo logçŠ¶æ€è®¾ä¸ºcommitï¼Œè¿™æ—¶å€™åªéœ€è¦å†™åˆ°page cacheé‡Œå°±è¡Œäº†ã€‚

![RECTIFY_IMG_20240609_152445.jpg](MySQL%2063748c5139f3404594dd27795d6cada0/RECTIFY_IMG_20240609_152445.jpg)

# æ‰§è¡Œå¼•æ“

å¸¸è§çš„æ•°æ®å¼•æ“ä¸º`InnoDB`å’Œ`MyISAM` ã€‚

- äº‹åŠ¡æ”¯æŒï¼š`InnoDB`æ”¯æŒäº‹åŠ¡ï¼Œå…·æœ‰ACIDç‰¹æ€§ï¼›`MyISAM`ä¸æ”¯æŒäº‹åŠ¡ã€‚
- é”ï¼š`InnoDB`æ”¯æŒè¡Œçº§é”ï¼›`MyISAM`ä½¿ç”¨è¡¨çº§é”ã€‚
- å¤–é”®çº¦æŸï¼š`InnoDB`æ”¯æŒå¤–é”®çº¦æŸï¼›`MyISAM`ä¸æ”¯æŒã€‚
- å´©æºƒæ¢å¤ï¼š`MyISAM` ä¸æ”¯æŒæ•°æ®åº“å¼‚å¸¸å´©æºƒåçš„æ¢å¤ï¼Œ`InnoDB`é€šè¿‡`redo log`ä¿è¯ã€‚
- ç´¢å¼•å®ç°ï¼š`MyISAM` ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¿å­˜å®Œæ•´çš„æ•°æ®è®°å½•ï¼Œ`InnoDB` ç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶åˆ†ç¦»ã€‚

ä½¿ç”¨åœºæ™¯ï¼š

- `InnoDB`ï¼šé€‚ç”¨äºéœ€è¦äº‹åŠ¡æ”¯æŒã€å¹¶å‘æ€§èƒ½å¥½ã€æœ‰é«˜å†™å…¥éœ€æ±‚çš„åº”ç”¨ï¼›
- `MyISAM`ï¼šé€‚ç”¨äºè¯»æ“ä½œé¢‘ç¹ã€å†™æ“ä½œå°‘çš„åº”ç”¨ã€‚

# ä¸»ä»å¤åˆ¶

## ç”¨é€”

1. æ•°æ®å®æ—¶å¤‡ä»½
2. è¯»å†™åˆ†ç¦»ï¼šå†™è¯·æ±‚é”è¡¨æ—¶ä¸å½±å“è¯»è¯·æ±‚ï¼ˆä¸»å†™ä»è¯»ï¼‰
3. æ¶æ„æ‹“å±•ï¼Œåˆ†æ‹…è´Ÿè½½

## åŸç†

![mysql-1bfbfcb5-2392-4f98-be1b-a66204da09e5.png](MySQL%2063748c5139f3404594dd27795d6cada0/mysql-1bfbfcb5-2392-4f98-be1b-a66204da09e5.png)

1. ä»èŠ‚ç‚¹åˆ›å»ºI/Oçº¿ç¨‹è¿æ¥ä¸»èŠ‚ç‚¹ã€‚
2. ä¸»èŠ‚ç‚¹åˆ›å»ºlog dumpçº¿ç¨‹ï¼Œå°†æŒ‡å®šæ–‡ä»¶å’Œä½ç½®åçš„æ—¥å¿—å‘é€ç»™å­èŠ‚ç‚¹ã€‚
3. ä»èŠ‚ç‚¹I/Oçº¿ç¨‹è·å–åˆ°æ•°æ®å†™å…¥relay logï¼Œå¹¶ä¿å­˜æ–‡ä»¶å’Œä½ç½®æ–¹ä¾¿ä¸‹æ¬¡è¯·æ±‚ã€‚
4. ä»èŠ‚ç‚¹SQLçº¿ç¨‹è¯»relay logå›æ”¾ã€‚

## ä¸»ä»å¤åˆ¶æ¨¡å‹

1. åŒæ­¥å¤åˆ¶ï¼šä¸»åº“æäº¤äº‹åŠ¡çš„çº¿ç¨‹ç­‰å¾…ä»åº“å¤åˆ¶æˆåŠŸå†å“åº”å®¢æˆ·ç«¯ï¼›
2. å¼‚æ­¥å¤åˆ¶ï¼šä¸»çº¿ç¨‹ä¸ç­‰å¾…bin logåŒæ­¥åˆ°ä»åº“ç›´æ¥è¿”å›ï¼›
3. åŠåŒæ­¥å¤åˆ¶ï¼šæœ‰éƒ¨åˆ†å­åº“å“åº”æˆåŠŸå°±è¿”å›ã€‚

# åˆ†åº“åˆ†è¡¨

## åŸºç¡€ç†è®º

- ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨ï¼Ÿ
    
    å°†åŸæ¥ç‹¬ç«‹çš„æ•°æ®åº“åˆ†ä¸ºè‹¥å¹²ä¸ªæ•°æ®åº“ï¼Œå°†ç‹¬ç«‹çš„å¤§è¡¨åˆ†ä¸ºè‹¥å¹²å°è¡¨ã€‚
    
- ä¸ºä»€ä¹ˆè¦åˆ†åº“åˆ†è¡¨ï¼Ÿ
    
    è§£å†³ç”±äºåº“è¡¨æ•°æ®é‡è¿‡å¤§è€Œå¯¼è‡´æ•°æ®åº“æ€§èƒ½é™ä½çš„é—®é¢˜ã€‚
    
    å…¶ä»–æ–¹å¼ï¼š
    
    - è½¯ä¼˜åŒ–ï¼š
        - åˆ†ææ…¢æŸ¥è¯¢sqlè¯­å¥ï¼Œåˆ†ææ‰§è¡Œè®¡åˆ’ï¼Œè¿›è¡Œsqlæ”¹å†™ï¼›
        - ä¼˜åŒ–æ•°æ®åº“è¡¨ç»“æ„ï¼›
        - ä¼˜åŒ–ç´¢å¼•ç­‰ã€‚
    - æå‡ç¡¬ä»¶é…ç½®-æˆæœ¬ä¸æ€§èƒ½æå‡ä¸åŒ¹é…ã€‚
- ä»€ä¹ˆæ—¶å€™åˆ†åº“åˆ†è¡¨ï¼Ÿ
    - ä¸è¦å…ˆå›ç­”åˆ†åº“åˆ†è¡¨ï¼éå¿…é¡»ä¸å¯¹æ•°æ®åº“è¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼Œé¦–å…ˆé‡‡å–å…¶ä»–æ–¹å¼ã€‚
    - å•è¡¨è¡Œæ•°è¶…è¿‡`500ä¸‡`è¡Œæˆ–è€…å•è¡¨å®¹é‡è¶…è¿‡`2GB`ï¼Œæ‰æ¨èè¿›è¡Œåˆ†åº“åˆ†è¡¨ã€‚
- å¦‚ä½•é€‰æ‹©åˆ†è¡¨é”®ï¼Ÿ
    
    æ‰¾åˆ°ä¸šåŠ¡çš„ä¸»é¢˜ï¼Œåœ¨ä¸šåŠ¡ä¸­ç»å¸¸æŸ¥è¯¢ä½¿ç”¨çš„å­—æ®µä½œä¸ºåˆ†ç‰‡é”®ã€‚
    
- åˆ†è¡¨ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ
    1. èŒƒå›´åˆ†è¡¨ã€‚ä¾‹å¦‚ï¼ŒæŒ‰ç…§æ—¶é—´èŒƒå›´åˆ’åˆ†ï¼Œä¸åŒçš„å¹´æœˆè®¢å•æ”¾åˆ°ä¸åŒçš„è¡¨ï¼š
        - ä¼˜ç‚¹ï¼šÂ æœ‰åˆ©äºæ‰©å®¹ï¼›
        - ç¼ºç‚¹ï¼šå¯èƒ½ä¼šæœ‰çƒ­ç‚¹é—®é¢˜ã€‚ä¾‹å¦‚æŸ¥è¯¢æ—¶é—´æœ€æ–°æ•°æ®çš„è¯·æ±‚å¤šã€‚
    2. å“ˆå¸Œå–æ¨¡ã€‚å–å“ˆå¸Œå€¼å†å–ä½™ï¼š
        - ä¼˜ç‚¹ï¼šä¸ä¼šå­˜åœ¨æ˜æ˜¾çš„çƒ­ç‚¹é—®é¢˜ï¼›
        - ç¼ºç‚¹ï¼šå‰æœŸè§„åˆ’ä¸å¥½ï¼Œæ‰©å®¹éº»çƒ¦ï¼Œè§£å†³æ–¹å¼ï¼šä¸€è‡´æ€§å“ˆå¸Œ
    
    3. èŒƒå›´+å“ˆå¸Œ
    

## åˆ†åº“åˆ†è¡¨çš„æ–¹å¼

### å‚ç›´åˆ†è¡¨

æŒ‰ç…§æŒ‡å®šå­—æ®µæ‹†åˆ†è¡¨ï¼Œæ¯å¼ è¡¨å­˜å‚¨ä¸€éƒ¨åˆ†æ•°æ®ï¼Œæ‹†è§£äº†åŸæœ‰çš„è¡¨ç»“æ„ï¼š

- ä¼˜ç‚¹ï¼šå……åˆ†æé«˜äº†**çƒ­ç‚¹æ•°**æ®çš„æ“ä½œæ•ˆç‡ï¼Œå•†å“ä¿¡æ¯çš„æ“ä½œçš„é«˜æ•ˆç‡ä¸ä¼šè¢«å•†å“æè¿°çš„ä½æ•ˆç‡æ‰€æ‹–ç´¯ï¼ˆå†·çƒ­æ•°æ®åˆ†ç¦»ï¼‰ï¼›é¿å…IOäº‰æŠ¢å’Œé”è¡¨å‡ ç‡ã€‚
- åŸåˆ™ï¼šå°†å¤§å­—æ®µã€ä¸å¸¸ç”¨çš„å­—æ®µæ‹†åˆ†ï¼Œå°†ç»å¸¸ç»„åˆæŸ¥è¯¢çš„åˆ—æ”¾åœ¨ä¸€å¼ è¡¨ä¸­ã€‚

### å‚ç›´åˆ†åº“

å‚ç›´åˆ†è¡¨æé«˜äº†çƒ­ç‚¹æ•°æ®çš„æŸ¥è¯¢æ•ˆç‡ï¼Œä½†æ²¡æœ‰çªç ´å•å°æœåŠ¡å™¨çš„æ€§èƒ½ç“¶é¢ˆã€‚å‚ç›´åˆ†åº“å°†**ä¸åŒç±»å‹çš„è¡¨**åˆ†å¸ƒåˆ°ä¸åŒçš„æ•°æ®åº“ä¸Šï¼Œæ¯ä¸ªåº“å¯ä»¥æ”¾åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚

- ä¼˜ç‚¹ï¼šæ”¹å–„äº†å•æœºç¡¬ä»¶èµ„æºç“¶é¢ˆï¼›å¯¹ä¸åŒä¸šåŠ¡çš„æ•°æ®è¿›è¡Œåˆ†åˆ«ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤ã€‚
- åŸåˆ™ï¼šä¸“åº“ä¸“ç”¨ï¼Œå…¬å…±è¡¨ç­‰é‡éƒ¨ç½²é¿å…è”æŸ¥ã€‚

### æ°´å¹³åˆ†è¡¨

æ°´å¹³åˆ†è¡¨å°±æ˜¯åœ¨åŒä¸€ä¸ªæ•°æ®åº“å†…ï¼ŒæŠŠåŒä¸€ä¸ªè¡¨çš„æ•°æ®æŒ‰ä¸€å®šè§„åˆ™æ‹†åˆ°å¤šä¸ªè¡¨ä¸­ï¼Œè¡¨çš„ç»“æ„æ²¡æœ‰å˜åŒ–ã€‚

- å¥½å¤„ï¼šè§£å†³å•è¡¨æ•°æ®è¿‡å¤§äº§ç”Ÿçš„æ€§èƒ½é—®é¢˜ï¼›é¿å…IOäº‰æŠ¢å¹¶å‡å°‘é”è¡¨çš„å‡ ç‡ã€‚

### æ°´å¹³åˆ†åº“

æ°´å¹³åˆ†è¡¨ä»…ä»…è§£å†³äº†å•è¡¨æ•°æ®é‡è¿‡å¤§çš„é—®é¢˜ï¼Œä½†æ˜¯æ²¡æœ‰è§£å†³å•åº“æ•°æ®é‡è¿‡å¤§çš„é—®é¢˜ã€‚æ°´å¹³åˆ†åº“æŠŠåŒä¸€ä¸ªè¡¨çš„æ•°æ®æŒ‰ä¸€å®šè§„åˆ™æ‹†åˆ°ä¸åŒçš„æ•°æ®åº“ä¸­ï¼Œæ¯ä¸ªåº“åˆå¯ä»¥éƒ¨ç½²åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚

- å¥½å¤„ï¼šè§£å†³å•åº“å¤§æ•°æ®ï¼Œé«˜å¹¶å‘çš„æ€§èƒ½ç“¶é¢ˆã€‚

## é—®é¢˜

1. äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼šåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œä¸åŒçš„æ•°æ®åº“ç”šè‡³æœåŠ¡å™¨å®Œæˆä¸€ä¸ªäº‹åŠ¡ã€‚
2. è·¨èŠ‚ç‚¹å…³è”æŸ¥è¯¢ï¼šå…³è”æŸ¥è¯¢çš„è¡¨ä¸åœ¨ä¸€ä¸ªæ•°æ®åº“â†’ä¸šåŠ¡å¼€å‘æ—¶éœ€è¦å°†åŸå…³è”æŸ¥è¯¢å˜æˆä¸¤æ¬¡æŸ¥è¯¢ã€‚
3. è·¨èŠ‚ç‚¹åˆ†é¡µã€æ’åºï¼šåœ¨æ¯ä¸ªåˆ†ç‰‡ä¸Šæ‰§è¡Œç›¸åº”çš„å‡½æ•°ï¼Œå†å¯¹æ€»ä½“çš„ç»“æœæ‰§è¡Œç›¸åŒçš„å‡½æ•°ã€‚å¦‚æœæ•°æ®é‡å¤§æ€§èƒ½å¾ˆå·®ã€‚
4. ä¸»é”®é¿é‡ï¼šä¸»é”®é‡å¤ã€‚

## ä¸­é—´ä»¶ShardingSphere

Sharding-JDBC æ˜¯ShardingSphereç§çš„ä¸€ä¸ªæ¨¡å—ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§ Java æ¡†æ¶ï¼Œåœ¨ JDBC å±‚æä¾›äº†æ‰©å±•æ€§æœåŠ¡ã€‚

### ç”¨Sharding-JDBCå®ç°åˆ†åº“åˆ†è¡¨

1. å¯¼å…¥ä¾èµ–ï¼›
2. é…ç½®æ•°æ®æºï¼Œä¸€ä¸ªæ•°æ®æºç›¸å½“äºä¸€ä¸ªåº“ï¼Œé…ç½®æ¯ä¸ªæ•°æ®æºçš„è¿æ¥ã€ç”¨æˆ·åã€å¯†ç ç­‰ï¼›
3. é…ç½®å¹¿æ’­è¡¨ï¼ˆå¹¿æ’­è¡¨å±äºæ•°æ®åº“ä¸­æ•°æ®é‡è¾ƒå°å’Œå˜åŠ¨è¾ƒå°‘ï¼Œä¸”å­˜åœ¨é«˜é¢‘è”åˆæŸ¥è¯¢çš„è¡¨ï¼‰ï¼›
    
    ```python
    # æŒ‡å®št_dictä¸ºå…¬å…±è¡¨ï¼Œå¤šä¸ªå…¬å…±è¡¨ä»¥é€—å·é—´éš”
    spring.shardingsphere.sharding.broadcastâ€tables=t_dict
    ```
    
4. è®¾ç½®é»˜è®¤æ•°æ®æºï¼Œæ²¡æœ‰åˆ†ç‰‡å¤„ç†çš„è®¿é—®é»˜è®¤æ•°æ®æºï¼›
    
    ```python
    # é…ç½®é»˜è®¤æ•°æ®æºï¼ˆç‰¹ç‚¹ï¼šå¯¹äºä¸åšåˆ†ç‰‡å¤„ç†çš„æ“ä½œï¼Œéƒ½ä¼šç›´æ¥è®¿é—®é»˜è®¤æ•°æ®æº
    # æœªé…ç½®åˆ†ç‰‡è§„åˆ™çš„è¡¨å°†é€šè¿‡é»˜è®¤æ•°æ®æºå®šä½
    spring.shardingsphere.sharding.default-data-source-name=ds4
    ```
    
5. å‚ç›´åˆ†åº“æˆ–æ°´å¹³åˆ†åº“åˆ†è¡¨éœ€è¦é…ç½®ï¼Œé…ç½®çœŸå®åº“è¡¨ä¸é€»è¾‘åº“è¡¨çš„æ˜ å°„ã€åˆ†ç‰‡é”®å’Œåˆ†ç‰‡ç®—æ³•
    1. inlineæ¨¡å¼
        
        ```python
        # ç”±æ•°æ®æºå + è¡¨åç»„æˆï¼Œä»¥å°æ•°ç‚¹åˆ†éš”ã€‚å¤šä¸ªè¡¨ä»¥é€—å·åˆ†éš”ï¼Œæ”¯æŒ inline è¡¨è¾¾å¼ã€‚
        spring.shardingsphere.sharding.tables.t_order.actual-data-nodes=ds$->{1..2}.t_order_$->{1..2}
        
        # å®šä¹‰åº“åˆ†ç‰‡
        spring.shardingsphere.sharding.tables.t_order.database-strategy.inline.sharding-column=user_id
        # åˆ†ç‰‡ç®—æ³•è¡Œè¡¨è¾¾å¼ï¼Œéœ€ç¬¦åˆ groovy è¯­æ³•
        spring.shardingsphere.sharding.tables.t_order.database-strategy.inline.algorithm-expression=ds$->{user_id % 2 +1}
        ```
        
    2. æ ‡å‡†æ¨¡å¼
        
        ```python
        # ç”¨äºå•åˆ†ç‰‡é”®çš„æ ‡å‡†åˆ†ç‰‡åœºæ™¯
        sharding.jdbc.config.sharding.tables.<logic-table-name>.database-strategy.standard.sharding-column= # åˆ†ç‰‡åˆ—åç§°
        sharding.jdbc.config.sharding.tables.<logic-table-name>.database-strategy.standard.precise-algorithm-class-name= # ç²¾ç¡®åˆ†ç‰‡ç®—æ³•ç±»åç§°ï¼Œç”¨äº = å’Œ INã€‚è¯¥ç±»éœ€å®ç° PreciseShardingAlgorithm æ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨
        sharding.jdbc.config.sharding.tables.<logic-table-name>.database-strategy.standard.range-algorithm-class-name= # èŒƒå›´åˆ†ç‰‡ç®—æ³•ç±»åç§°ï¼Œç”¨äº BETWEENï¼Œå¯é€‰ã€‚è¯¥ç±»éœ€å®ç° RangeShardingAlgorithm æ¥å£å¹¶æä¾›æ— å‚æ•°çš„æ„é€ å™¨
        ```
        
        å®ç°Precise/RangeShardingAlgorithmæ¥å£ï¼Œé‡å†™doShardingæ–¹æ³•ï¼Œè¿”å›æ•°æ®æºã€‚ä¼ å…¥æ•°æ®æºï¼ˆè¡¨ï¼‰é›†åˆã€åˆ†ç‰‡ä¿¡æ¯ï¼ˆåˆ†ç‰‡é”®ã€åˆ†ç‰‡å€¼ã€é€»è¾‘è¡¨åç§°ï¼‰
        
        ```java
        public class CommonAlgorithm4Db implements PreciseShardingAlgorithm<Long>, RangeShardingAlgorithm<Long> {
        
            /**
             * å®šä¹‰åŒ¹é…æ•°æ®æºçš„æ–¹æ³•
             * @param dsNames æ‰€æœ‰é…ç½®çš„æ•°æ®æºçš„é›†åˆds${1..2} åŒ…å«ds1 ds2å°è£…åˆ°è¯¥é›†åˆä¸‹
             *                è¯´ç™½äº†å°±æ˜¯sharindingæŠŠæ‰€æœ‰çš„æ•°æ®æºéƒ½ç»™ä½ ï¼Œç„¶åè®©ä½ æ ¹æ®ç‰‡é”®å€¼é€‰æ‹©
             * @param shardingValue å°è£…åˆ†ç‰‡ç›¸å…³ä¿¡æ¯
             * @return è¿”å›åŒ¹é…çš„æ•°æ®æº
             */
            @Override
            public String doSharding(Collection<String> dsNames, PreciseShardingValue<Long> shardingValue) {
                //è·å–æ•°æ®åº“åˆ†ç‰‡çš„å­—æ®µåç§° user_id = in
                String columnName = shardingValue.getColumnName();
                //è·å–é€»è¾‘è¡¨åç§°
                String logicTableName = shardingValue.getLogicTableName();
                //è·å–ç‰‡é”®å¯¹åº”çš„å€¼ select * from t_order where user_id=10,è¿™é‡Œçš„valueå°±ç­‰äº10
                Long value = shardingValue.getValue();
                //ä¸€èˆ¬æ˜¯æ ¹æ®ç‰‡é”®å€¼è·å–å¯¹åº”çš„æ•°æ®æºï¼Œå¹¶è¿”å›
                String sufix=String.valueOf(value % 2 +1);
                String dsName = dsNames.stream().filter(ds -> ds.endsWith(sufix)).findFirst().get();
                return dsName;
            }
        
            /**
             *
             * @param dsNames æ•°æ®æºé›†åˆ
             * @param shardingValue èŒƒå›´æŸ¥è¯¢ä¿¡æ¯å°è£…
             * @return
             */
            @Override
            public Collection<String> doSharding(Collection<String> dsNames, RangeShardingValue<Long> shardingValue) {
                //è·å–åˆ†ç‰‡å­—æ®µ
                String columnName = shardingValue.getColumnName();
                //è·å–é€»è¾‘è¡¨
                String logicTableName = shardingValue.getLogicTableName();
                //è·å–èŒƒå›´æ•°æ®
                Range<Long> valueRange = shardingValue.getValueRange();
                //select * from t_order where user_id between 1 and 20;
                //åˆ¤æ–­æ˜¯å¦æœ‰ä¸Šé™å€¼
                if (valueRange.hasUpperBound()) {
                    //è·å–ä¸Šé™å€¼ 20
                    Long uppper = valueRange.upperEndpoint();
                    System.out.println(uppper);
                }
                if (valueRange.hasLowerBound()){
                    Long lower = valueRange.lowerEndpoint();
                    System.out.println(lower);
                }
                //ç†è®ºä¸Šè¦æ ¹æ®ä¸Šé™å€¼å’Œä¸‹é™å€¼è·å–æ»¡è¶³æ¡ä»¶çš„æ•°æ®æºé›†åˆ
                return Arrays.asList("ds1","ds2");
            }
        }
        ```
        

### åŸç†æµç¨‹

1. è§£æSQLï¼Œè·å–åˆ†ç‰‡é”®å€¼ï¼Œå¦‚order_idï¼›
2. é€šè¿‡é…ç½®çš„åˆ†ç‰‡é”®å’Œåˆ†ç‰‡ç®—æ³•æ”¹å†™SQLè¯­å¥ï¼›
3. æ‰§è¡Œæ”¹å†™åçš„çœŸå®SQLè¯­å¥ï¼›
4. å°†æ‰€æœ‰çœŸæ­£æ‰§è¡ŒSQLçš„ç»“æœè¿›è¡Œæ±‡æ€»åˆå¹¶å¹¶è¿”å›ã€‚