# 索引管理器

# 理论基础

## 主要功能

实现类似于MyISM的**非聚簇索引**，索引的叶子节点存储的是数据的Uid。

## B+树

B+树是一种多叉排序树，非叶子节点不保存记录，只进行数据索引。

- B+树的所有查询都必须从根节点遍历到叶子节点，这使得所有关键字的查询路径长度相同，从而保证了每个数据的查询效率相对稳定。
- B+树的叶子节点之间通过指针相连，形成了一个有序链表，这在进行范围查询时特别有用，因为可以直接通过链表遍历来获取范围内的数据。

### B+树的插入

1. B+树的插入在叶子节点进行，首先找到插入的叶子节点；
2. 如果当前叶子节点的关键字的数量小于阶数，则直接插入；
3. 如果插入关键字后当前节点关键字数目等于阶数，则分裂成两个新的节点，每个节点分得一半的数据，并将前面节点的最大关键字插入到父节点中；
4. 重复第3步的操作，如果根节点分裂则创建新的根节点。

### B+树的删除

由于删除数据只是在数据的XMax字段上加上事务的ID，并没有真正地删除，B+树索引也不需要提供删除操作，所以也不必考虑非叶子节点的关键字数目少于阶数/2。

# 设计与实现

## 数据结构

### 节点 Node

索引占用实际的物理空间，B+树的每一个节点存储在一条DataItem中，且长度是固定的，即能够存放的最大key-uid键值对个数是固定的，对应了B+树的阶数。

![image.png](%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86%E5%99%A8%20e0d2b9a7d86c487cbed9ab44175509f5/image.png)

节点应当提供的功能包括但不限于：

- 查找：
    - 等值查找：根据某一个关键字查找下一个节点的UID；
    - 范围查找：根据左闭右开区间查找该节点中满足范围的关键字对应的UID集合。
- 相连节点：
    - 非根节点返回父节点；
    - 叶子节点可以返回下一个兄弟节点（链表）；
    - 递归查询给定关键字所在的叶子节点。
- 插入数据：
    - 插入key-uid键值对，如果节点满了需要分裂，产生下一个兄弟节点。

### B+树 BPlusTree

BPlusTree依赖于DM数据管理器，可以读写操作Node节点，向上提供了索引查询的功能。其本身只需要记录Root根节点，需要其他节点的时候从根节点开始读取，读完释放。提供的功能包括：

- 等值查询；
- 范围查询；
- 插入节点。

## 总体架构

![image.png](%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86%E5%99%A8%20e0d2b9a7d86c487cbed9ab44175509f5/image%201.png)

# 总结

索引管理（IM）通过B+树实现了非聚簇索引。B+树只在叶子节点存储数据，相对于其他数据结构，在相同大小的磁盘块中可以存储更多的节点，**减少磁盘IO**操作次数，提高了数据检索效率，故而被广泛用在了MyISM、InnoDB等数据库引擎中，使用B+树，**关键字查询路径长度相同**、**插入数据不会有太复杂的树型变化**、可以**支持范围查找**，提供了稳定的查询效率。

使用一个数据项作为一个索引的节点Node，节点中记录了父节点、子节点的指针，还提供了下一个节点的指针供叶子节点使用，串联起所有的叶子节点，可以提供全表扫描的功能。