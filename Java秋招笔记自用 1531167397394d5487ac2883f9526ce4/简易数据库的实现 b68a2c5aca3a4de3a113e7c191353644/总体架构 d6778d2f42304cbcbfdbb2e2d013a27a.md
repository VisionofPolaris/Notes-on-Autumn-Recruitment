# 总体架构

# 总体架构

## 总体架构

整个项目分为客户端和服务端，客户端和服务端之间通过Socket进行通信：

- 前端负责读取用户的输入，传入服务端，输出返回的结果，并等待下一次输入；
- 服务端负责SQL的解析、数据的读取、数据的存储等。

![image.png](%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84%20d6778d2f42304cbcbfdbb2e2d013a27a/image.png)

## 服务端

服务端包括：

- 解析器：负责解析类SQL语句；
- 表管理器：管理所有的表和字段，调度SQL语句给具体的表和字段执行；
- 索引管理器：管理索引，查询相关的数据指针返回；
- 版本管理器：版本控制，负责解决数据库的隔离性，实现读已提交和可重复读隔离级别；
- 数据管理器：管理数据库的数据与日志，负责读写文件、日志恢复；
- 事务管理器：管理事务状态。

## 执行一条Select语句

![image.png](%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84%20d6778d2f42304cbcbfdbb2e2d013a27a/image%201.png)

1. 客户端发送类SQL语句给服务端；
2. 解析器负责解析SQL，如数据操作的类型（select）、操作的表名、操作的字段和条件等；
3. 表管理器找到对应的表格，通过查询的条件字段请求索引管理器；
4. 索引管理器通过索引或全表扫描得到数据的唯一地址返回表管理器；
5. 表管理器调用版本管理器通过唯一地址读取具体的数据；
6. 版本管理器根据数据库的隔离级别和事务ID判断数据的可见性，将过滤后的数据返回；
7. 表管理器返回数据，服务端将查询结果发送给客户端。

# 文件

## 文件介绍

数据库的数据均保存在四个文件中：

1. DB文件：数据库的数据均保存在该文件中，包括数据记录、索引节点、表结构、字段信息等；
2. LOG文件：保存了数据库的日志，类似于InnoDB的RedoLog，记录的是具体改变后的数据，且只记录增删改操作所改变的数据；
3. XID文件：每个事务分配一个XID，根据XID记录了事务的状态；
4. BT文件：表启动文件，记录了头表的位置，数据库启动时会将库中的所有表加载到表管理器中。

## DB文件

### 文件组织

- DB文件是数据库中最主要的文件，又被划分为**数据页Page**，数据页的大小固定，是数据管理器读取数据的基本单位。
- 在每个数据页中又包含了**数据项DataItem**，每个数据项大小不固定，其长度记录在数据项中。每个数据项有一个唯一的编号UID由其页号和页内偏移组成，数据管理器可以通过UID直接定位到该条数据并返回，所以数据项也是数据管理器给上层的数据单位。

### 数据项

数据项中包含的具体数据只要包括以下四种：

- **数据条目Entry**：就是数据表中每条记录；
- **节点Node**：B+树的节点，索引数据用；
- **表结构Table**：记录了表的信息，包括表名、字段等；
- **字段结构Field**：记录了字段信息，包括字段名、数据类型、索引头等。

以上四种不同的数据实际上是**交错分布**在各个数据页上的，但通过指针（UID）可以将所有的数据组织起来。

![image.png](%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84%20d6778d2f42304cbcbfdbb2e2d013a27a/image%202.png)

对于数据项的操作：

- 只有**读**、**删除**、**插入**三个操作，更新操作是删除和插入的组合；
- 删除并不是真正的删除，而是通过其中的字段指明该数据项是否有效；
- 由于没有真正删除，插入数据项时直接在某个数据页的最下方空白处写入即可。